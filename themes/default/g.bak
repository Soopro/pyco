{% set navigation = saltshaker(posts,["nav","url"],true) %}

<!-- taxonomy -->
{% set terms = saltshaker(posts,[meta.taxonomy]) if meta.taxonomy %}
{% set raw_posts = terms if terms else posts %}

<!-- result posts -->
{% set posts = [] %}
{% for post in raw_posts if (not terms) or (terms and args.term == post[meta.taxonomy])%}
	{% do posts.append(post) %}
{% endfor %}

<!-- paged posts -->
{% set paged = args.paged|int if args.paged and args.paged|int > 0 else 1 %}
{% set perpage = site_meta.perpage if site_meta.perpage else 4 %}

{% set result_posts = [] %}
{% for post in posts if (not paged_post_types) or (post.type in paged_post_types) %}
	{% do result_posts.append(post) %}
{% endfor %}


{% set paged_posts = [] %}
{% for post in result_posts %}
	{% if loop.index > paged*perpage%}
		{% break %}
	{% endif %}
	{% if loop.index < (paged-1)*perpage+1%}
		{% continue %}
	{% endif %}
	{% do paged_posts.append(post) %}
{% endfor %}

<!-- pagination -->
{% set result_length = result_posts|length %}
{% set max_pages = (result_length//perpage)+1 if (result_length % perpage) > 0 else (result_length//perpage) %}

{% set pagination = {
	"max_pages": max_pages,
	"current_page": paged if paged <= max_pages else max_pages,
	"has_next_page": true if paged < max_pages else none,
	"has_prev_page": true if paged > 1 else none,
	}
%}
